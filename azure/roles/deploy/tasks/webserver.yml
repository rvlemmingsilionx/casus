- name: Include webserver Vars
  include_vars:
    dir: vars

- name: Maken Network Security Groep voor Webservers
  azure_rm_securitygroup:
    resource_group: "{{ resourcegroup }}"
    name: "{{ item.nsgname}}"
    rules:
      - name: SSH
        protocol: Tcp
        destination_port_range: 22
        access: Allow
        priority: 100
        direction: Inbound
  with_items: "{{ nsgs.web }}"

- name: Maken nics
  azure_rm_networkinterface:
    resource_group: "{{ resourcegroup }}"
    name: "{{ item.nicname }}"
    virtual_network: "{{ vnetname }}"
    subnet: "{{ item.websubnet}}"
    security_group: "{{ item.nsg}}"
    ip_configurations:
      - name: "{{ item.ipconfig }}"
        load_balancer_backend_address_pools:
          - "{{ loadbalancer1.state.backend_address_pools[0].id }}"
          - name: "{{ backendpoolname }}"
            load_balancer: loadbalancer01
  with_items: "{{ nics.web }}"


- name: Maken VM
  azure_rm_virtualmachine:
    resource_group: "{{ resourcegroup }}"
    name: "{{ item.name }}"
    vm_size: "{{ item.vmsize }}"
    admin_username: "{{ item.adminusername }}"
    admin_password: "{{ item.adminpassword }}"
    network_interfaces: "{{ item.networkinterfaces }}"
    managed_disk_type: "{{ item.manageddisktype }}"
    image:
      offer: "{{ item.os }}"
      publisher: "{{ item.publish }}"
      sku: "{{ item.type }}"
      version: "{{ item.versie }}"
    remove_on_absent: ["all"]
    state: "{{ item.status }}"
  with_items: "{{ vms.web }}"
