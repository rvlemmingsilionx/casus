---
- hosts: localhost
  connection: local
  gather_facts: true
  vars_prompt:
    - name: choise
      prompt: "Wil je Azure inrichten? (y/n)"
      private: no

  pre_tasks:
    - name: Include Vars
      include_vars: "{{ item }}"
      with_items:
        - 'vars/secret.yml'
        - 'vars/vars.yml'

  roles:
    - { role: deploy, when: choise  == "y" }

  tasks:
    - name: Set azure_state Deployed
      lineinfile:
        path: group_vars/all
        regexp: '^azure_state:'
        line: 'azure_state: deployed'
      when: choise == "y"

    - name: Add public ip of the managementnode to the group
      add_host:
        name: "{{ ip_address.state.ip_address }}"
        groups: confmanagementnode
      when: choise == "y"

- hosts: confmanagementnode
  gather_facts: true
  vars_prompt:
    - name: choise
      prompt: "Wil je de management node inrichten? (y/n)"
      private: no

  pre_tasks:
    - name: Include Vars
      include_vars: "{{ item }}"
      with_items:
        - 'vars/secret.yml'
        - 'vars/vars.yml'

  roles:
    - { role: mmnode, when: azure_state == "deployed" and choise == "y"}

  tasks:
    - name: Set azure_state Readytodeploy
      lineinfile:
        path: group_vars/all
        regexp: '^azure_state:'
        line: 'azure_state: RedyToDeploy'


- hosts: allservers
  gather_facts: true
  vars_prompt:
    - name: choise
      prompt: "Wil je de complete infrastructuur inrichten?? (y/n)"
      private: no

  pre_tasks:
    - name: Include Vars
      include_vars: "{{ item }}"
      with_items:
        - 'vars/secret.yml'
        - 'vars/vars.yml'

  roles:
    - { role: configure, when: choise == "y"}

- hosts: localhost
  connection: local
  gather_facts: true
  vars_prompt:
    - name: choise
      prompt: "Wil je de undeployment starten? (y/n)"
      private: no

  pre_tasks:
    - name: Include Vars
      include_vars: "{{ item }}"
      with_items:
        - 'vars/secret.yml'
        - 'vars/vars.yml'

  roles:
    - { role: undeploy, when: choise == "y" }
